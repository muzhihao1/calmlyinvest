name: Verceléƒ¨ç½²è°ƒè¯•

on:
  workflow_dispatch:
  push:
    branches: [main]
  
jobs:
  debug-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: å®‰è£…Vercel CLI
      run: npm install -g vercel
    
    - name: æ£€æŸ¥APIå‡½æ•°æ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥APIå‡½æ•°æ–‡ä»¶ç»“æ„"
        echo "========================"
        
        echo -e "\næ ¹ç›®å½•APIæ–‡ä»¶:"
        ls -la api/ || echo "æœªæ‰¾åˆ°apiç›®å½•"
        
        echo -e "\néªŒè¯å‡½æ•°å¯¼å‡º:"
        for file in api/*.ts; do
          if [ -f "$file" ]; then
            echo -n "æ£€æŸ¥ $file... "
            if grep -q "export default" "$file"; then
              echo "âœ…"
            else
              echo "âŒ ç¼ºå°‘export default"
              cat "$file" | head -20
            fi
          fi
        done
    
    - name: éªŒè¯TypeScriptç¼–è¯‘
      run: |
        echo "ğŸ”§ éªŒè¯TypeScriptç¼–è¯‘"
        echo "===================="

        # å®‰è£…ä¾èµ–
        npm ci

        # å°è¯•ç¼–è¯‘æ¯ä¸ªAPIæ–‡ä»¶
        for file in api/*.ts; do
          if [ -f "$file" ]; then
            echo -e "\nç¼–è¯‘ $file..."
            npx tsc "$file" --noEmit --esModuleInterop --skipLibCheck || {
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              echo "æŸ¥çœ‹å‰50è¡Œä»£ç :"
              head -50 "$file"
            }
          fi
        done
    
    - name: æ¨¡æ‹ŸVercelæ„å»ºç¯å¢ƒ
      run: |
        echo "ğŸ—ï¸ æ¨¡æ‹ŸVercelæ„å»º"
        echo "================="

        # æ£€æŸ¥vercel.json
        if [ -f "vercel.json" ]; then
          echo "vercel.jsonå†…å®¹:"
          cat vercel.json
        fi

        # æµ‹è¯•æ„å»º
        npm run build
    
    - name: åˆ›å»ºè¯Šæ–­æŠ¥å‘Š
      if: failure()
      run: |
        echo "ğŸ“‹ åˆ›å»ºè¯Šæ–­æŠ¥å‘Š"
        echo "=============="
        
        cat > deployment-debug-report.md << EOF
        # Verceléƒ¨ç½²è°ƒè¯•æŠ¥å‘Š
        
        ç”Ÿæˆæ—¶é—´: $(date)
        
        ## æ–‡ä»¶ç»“æ„
        \`\`\`
        $(tree -L 3 -I 'node_modules|dist' || find . -type f -name "*.ts" -o -name "*.js" | grep -E "(api|server)" | sort)
        \`\`\`
        
        ## APIå‡½æ•°æ£€æŸ¥
        $(for f in api/*.ts; do [ -f "$f" ] && echo "- $f: $(grep -c "export default" "$f") exports"; done)
        
        ## æ„å»ºæ—¥å¿—
        æŸ¥çœ‹ä¸Šé¢çš„æ„å»ºè¾“å‡º
        
        ## å»ºè®®ä¿®å¤æ­¥éª¤
        1. ç¡®ä¿æ‰€æœ‰APIå‡½æ•°éƒ½æœ‰ \`export default handler\`
        2. æ£€æŸ¥TypeScriptç±»å‹å¯¼å…¥è·¯å¾„
        3. éªŒè¯CORSé…ç½®
        4. ç¡®è®¤ç¯å¢ƒå˜é‡è®¾ç½®
        EOF
        
        cat deployment-debug-report.md
    
    - name: ä¸Šä¼ è°ƒè¯•æŠ¥å‘Š
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: vercel-debug-report
        path: deployment-debug-report.md