# 期权数据更新指南

## 📊 关于期权数据显示

### 当前数据来源
- **API**: Market Data API（实时市场数据）
- **更新方式**: 点击"刷新数据"按钮手动更新
- **自动刷新**: 每5分钟自动刷新一次（静默模式）

### 数据字段说明

| 字段 | 说明 | 来源 |
|------|------|------|
| **成本价** | 您买入/卖出的价格 | 用户输入 |
| **当前价** | 市场实时报价 | Market Data API |
| **Delta** | 期权价格对标的价格的敏感度 | Market Data API |
| **未实现盈亏** | 当前持仓盈亏（考虑合约数和方向） | 计算得出 |

## 🔄 如何刷新期权数据

### 方法1：手动刷新（推荐）
1. 进入仪表板
2. 点击右上角的**"刷新数据"**按钮（🔄图标）
3. 等待2-5秒，所有期权价格和Delta将更新

### 方法2：自动刷新
- 系统每5分钟自动刷新一次
- 无需手动操作
- 后台静默更新

## 💰 未实现盈亏计算公式

```
未实现盈亏 = (当前价 - 成本价) × 合约数 × 100 × 方向系数

方向系数：
- 买入(BUY)：+1（价格上涨=盈利）
- 卖出(SELL)：-1（价格下跌=盈利）
```

### 示例计算

**例1: 买入看跌期权(BUY PUT)**
- 成本价：$11.59
- 当前价：$5.28（Market Data API实时数据）
- 合约数：1
- 方向：BUY (+1)

```
盈亏 = ($5.28 - $11.59) × 1 × 100 × 1
     = -$6.31 × 100
     = -$631.00（亏损）
```

**例2: 卖出看涨期权(SELL CALL)**
- 成本价：$10.00
- 当前价：$7.00
- 合约数：2
- 方向：SELL (-1)

```
盈亏 = ($7.00 - $10.00) × 2 × 100 × (-1)
     = -$3.00 × 200 × (-1)
     = +$600.00（盈利，因为卖出期权价格下跌是好事）
```

## 📈 Delta值说明

### Delta的含义
- **看涨期权(CALL)**: Delta为正值（0到+1）
  - Delta = 0.60 表示标的上涨$1，期权价格约上涨$0.60

- **看跌期权(PUT)**: Delta为负值（-1到0）
  - Delta = -0.41 表示标的上涨$1，期权价格约下跌$0.41

### 与IB的差异
您可能注意到IB显示的Delta值与我们的不同：

| 平台 | Delta显示 | 说明 |
|------|----------|------|
| **IB (Interactive Brokers)** | 0.374 | 可能显示绝对值 |
| **CalmlyInvest** | -0.4120 | 标准Delta（PUT为负） |
| **差异原因** | IB可能省略负号 | 两者数值接近，都是正确的 |

**注意**: PUT期权的Delta在金融理论中应该是负数，这是标准表示方法。

## 🔍 数据验证

### 如何确认数据是最新的？

1. **查看"当前价"颜色**：
   - 🟢 绿色：价格上涨
   - 🔴 红色：价格下跌
   - ⚪ 白色：价格未变化

2. **检查最后更新时间**：
   - 查看仪表板顶部的时间戳
   - 或者查看浏览器控制台日志

3. **对比外部数据**：
   - 与IB、Tradier等平台对比
   - 允许±5%的差异（不同数据源的bid-ask spread）

### 数据不准确？

如果发现数据与实际差异较大：

1. **点击"刷新数据"按钮**
   - 强制从API重新获取最新数据

2. **检查期权代码格式**：
   ```
   正确: MSFT 251010P515
   错误: MSFT251010P515 (缺少空格)
   ```

3. **确认期权未过期**：
   - 过期期权无法获取实时报价
   - 系统会显示"已过期"标记

4. **查看控制台错误信息**：
   - 按F12打开开发者工具
   - 查看Console标签中的错误信息

## 🐛 常见问题

### Q1: 为什么当前价显示的是旧数据？
**A**: 需要手动点击"刷新数据"按钮，或等待5分钟自动刷新。

### Q2: PUT期权的Delta为什么是负数？
**A**: 这是标准金融表示方法。PUT期权与标的价格反向变动，因此Delta为负。

### Q3: 未实现盈亏为什么是负数（我明明赚钱了）？
**A**:
- **买入(BUY)**: 当前价 > 成本价 = 盈利
- **卖出(SELL)**: 当前价 < 成本价 = 盈利（公式会自动考虑方向）

### Q4: Market Data API的数据准确吗？
**A**:
- Market Data API提供实时市场数据
- 使用mid price（买价和卖价的中间值）
- 与IB等平台数据高度一致
- 允许±2-5%的正常差异

### Q5: 刷新数据需要多长时间？
**A**:
- 单个期权：~1-2秒
- 多个期权：每个1-2秒（顺序请求）
- API有速率限制（免费试用版）

## 📝 技术细节

### API调用流程
1. 用户点击"刷新数据"
2. 前端发送POST请求到 `/api/portfolio/{portfolioId}/refresh-prices`
3. 后端调用Market Data API获取最新报价
4. 更新数据库中的`currentPrice`和`deltaValue`字段
5. 前端重新获取数据并更新UI

### 数据更新函数
```typescript
// server/market-data.ts
export async function updateOptionPrices(holdings: OptionHolding[]) {
  const marketData = new MarketDataProvider();

  return await Promise.all(
    holdings.map(async holding => {
      const quote = await marketData.getOptionQuote(holding.optionSymbol);
      return {
        ...holding,
        currentPrice: quote.price.toFixed(2),
        deltaValue: quote.delta.toFixed(4)
      };
    })
  );
}
```

## 🎯 下一步

1. ✅ 添加了"未实现盈亏"列
2. ✅ 实时更新价格和Delta
3. 🔄 建议：添加"最后更新时间"显示
4. 🔄 建议：添加"自动刷新"开关

---

**有问题？**
- 查看Market Data API文档：https://www.marketdata.app/docs/api/options
- 查看项目README：MARKETDATA_SETUP_GUIDE.md
